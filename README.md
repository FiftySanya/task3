# Дослідження обмежень ресурсів у середовищі Docker

## Зміст
[Завдання 1: Встановлення та дослідження лімітів відкритих файлів](#завдання-1-встановлення-та-дослідження-лімітів-відкритих-файлів)
[Завдання 2: Дослідження лімітів відкритих файлових дескрипторів](#завдання-2-дослідження-лімітів-відкритих-файлових-дескрипторів)
[Завдання 3: Дослідження обмежень на розмір файлу](#завдання-3-дослідження-обмежень-на-розмір-файлу)

---

## Завдання 1: Встановлення та дослідження лімітів відкритих файлів

### Опис
Це завдання досліджує механізми обмеження кількості відкритих файлових дескрипторів у FreeBSD системі. Ми вивчаємо як переглядати поточні значення обмежень, їх м'які (soft) та жорсткі (hard) значення, а також можливості зміни цих обмежень з правами root.

### Результати виконання
- ```bash
  # Запуск контейнера FreeBSD 14 за допомогою podman (FreeBSD нативно не підтримує Docker)
  podman run -it --rm quay.io/dougrabson/freebsd14-minimal /bin/sh
  
  # Перегляд м'якого ліміту відкритих файлів
  ulimit -aS | grep "open files"
  open files                      (-n)  116964
  
  # Перегляд жорсткого ліміту відкритих файлів
  ulimit -aH | grep "open files"
  open files                      (-n)  116964
  
  # Зміна ліміту на нове значення
  ulimit -n 3000
  
  # Спроба збільшити ліміт
  ulimit -n 3001
  
  # Зменшення ліміту
  ulimit -n 2000

  # Перегляд м'якого ліміту відкритих файлів
  ulimit -aS | grep "open files"
  open files                      (-n)  2000

  # Перегляд жорсткого ліміту відкритих файлів
  ulimit -aH | grep "open files"
  open files                      (-n)  2000

  # Вихід з контейнеру і перевірка обмжень оригінального образу
  exit
  ulimit -n
  116964
  ```

### Висновки
- Система FreeBSD 14 за замовчуванням налаштована з досить високим значенням максимальної кількості відкритих файлів - 116964.
- У FreeBSD, як і в інших UNIX-подібних системах, користувач із привілеями root може змінювати будь-які значення лімітів.
- При зміні ліміту через `ulimit -n` змінюються обидва значення (м'яке і жорстке) одночасно на правах root (має повний контроль над цими лімітами).

## Завдання 2: Дослідження лімітів відкритих файлових дескрипторів

### Опис
Це завдання досліджує поведінку програми при досягненні максимальної кількості відкритих файлів, встановленої системними обмеженнями. За допомогою утиліт `ktrace` та `kdump` ми відстежуємо системні виклики open() та аналізуємо поведінку системи при досягненні ліміту.

### Команди трасування (podman)
- ```bash
  # Встановлення обмеження на кількість відкритих файлів
  ulimit -n 100
  
  # Відстеження системних викликів за допомогою ktrace
  ktrace -t c -f trace.out ./task2
  
  # Аналіз результатів трасування за допомогою kdump
  kdump -f trace.out | grep open
  ```
  
### Результати виконання
- ```
  ....
  Opened file file94, fd=97
  Opened file file95, fd=98
  Opened file file96, fd=99
  Failed to open file file97: Too many open files
  ```
  ```
  1618 task2    CALL  open(0x3161bad98e01,0x100000<O_RDONLY|O_CLOEXEC>)
  1618 task2    RET   open 3
  1618 task2    CALL  open(0x82138febb,0x120004<O_RDONLY|O_NONBLOCK|O_DIRECTORY|O_CLOEXEC>)
  1618 task2    RET   open -1 errno 2 No such file or directory
  1618 task2    CALL  open(0x3161bad98a26,0x100000<O_RDONLY|O_CLOEXEC>)
  1618 task2    RET   open 3
  ```

### Поведінка програми при наближенні до ліміту
- Програма task2 успішно відкриває файли до досягнення ліміту в 100 файлів.
- При спробі відкрити файл file97, система повертає помилку "Too many open files", що відповідає системному коду помилки EMFILE (24).
- Ліміт, встановлений за допомогою `ulimit -n 100`, є ефективним і чітко обмежує кількість файлів, які процес може відкрити одночасно.

### Аналіз системних викликів за допомогою ktrace/kdump
- Системний виклик `open()` використовується з різними наборами прапорців:
  - `O_RDONLY|O_CLOEXEC`: відкриття файлу лише для читання з автоматичним закриттям при виконанні exec().
  - `O_RDONLY|O_NONBLOCK|O_DIRECTORY|O_CLOEXEC`: спроба відкрити директорію без блокування, яка завершилася невдачею (errno 2: No such file or directory).
  - Виклик, що повертає помилку з кодом 2 (No such file or directory), не пов'язаний з лімітом відкритих файлів, а вказує на спробу відкрити неіснуючий файл або директорію.

### Висновки
- Програми, які працюють з великою кількістю файлів, повинні:
  - Перевіряти помилки при відкритті файлів і правильно їх обробляти
  - Своєчасно закривати непотрібні файлові дескриптори
  - Системні адміністратори повинні встановлювати відповідні ліміти для різних користувачів та сервісів в залежності від їх потреб.

## Завдання 3: Дослідження обмежень на розмір файлу

### Опис
Це завдання досліджує механізм обмеження максимального розміру файлів у FreeBSD. Ми створили програму, яка імітує кидання шестигранного кубика і записує результати в файл, а потім перевіряємо поведінку системи при досягненні встановленого обмеження на розмір файлу.

### Тестування з обмеженням розміру файлу (podman)
- ```bash
  ulimit -f 1
  ```
- ```
  ./task3
    Filesize limit exceeded
  ```
  
### Механізм обмеження розміру файлу
- Команда `ulimit -f 1` встановлює максимальний розмір файлу в 1 блок, що в FreeBSD дорівнює 1 КБ (1024 байти).
- Обмеження встановлюється для поточної сесії оболонки.
- При спробі програми перевищити цей ліміт, система повертає помилку "Filesize limit exceeded".

### Аналіз розміру даних, що записуються
- Кожен результат кидка кубика записується у форматі:
   - Одна цифра (від 1 до 6)
   - Символ нового рядка (`\n`)
   - Всього: 2 байти на кожен кидок

- Максимальна кількість кидків, які можна записати при ліміті 1 КБ:
   - Максимальний розмір файлу: 1024 байти
   - Розмір одного запису: 2 байти
   - Теоретична максимальна кількість записів: 1024 / 2 = 512 кидків

### Висновки
- Механізм `ulimit -f` ефективно обмежує максимальний розмір файлів, які може створити процес у FreeBSD.
- При спробі перевищити встановлений ліміт, система генерує помилку "Filesize limit exceeded".
- Обмеження розміру файлів є важливим механізмом захисту від випадкового або зловмисного заповнення дискового простору.

